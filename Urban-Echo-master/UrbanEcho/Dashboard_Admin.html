<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Urban Echo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <div class="w-64 bg-blue-800 text-white p-4 flex flex-col">
            <h1 class="text-2xl font-bold mb-8">Urban Echo</h1>

            <div class="flex items-center mb-6 p-2 bg-blue-700 rounded-lg">
                <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center mr-3">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div>
                    <p class="font-medium" id="admin-name">Admin User</p>
                    <p class="text-xs text-blue-200">Administrator</p>
                </div>
            </div>

            <nav class="flex-grow">
                <ul class="space-y-2">
                    <li>
                        <a href="#" class="block px-4 py-2 bg-blue-700 rounded flex items-center">
                            <i class="fas fa-tachometer-alt mr-3"></i> Dashboard
                        </a>
                    </li>
                    <li>
                        <a href="#" class="block px-4 py-2 hover:bg-blue-700 rounded flex items-center">
                            <i class="fas fa-flag mr-3"></i> All Reports
                        </a>
                    </li>
                    <li>
                        <a href="#" class="block px-4 py-2 hover:bg-blue-700 rounded flex items-center">
                            <i class="fas fa-users mr-3"></i> User Management
                        </a>
                    </li>
                    <li>
                        <a href="#" class="block px-4 py-2 hover:bg-blue-700 rounded flex items-center">
                            <i class="fas fa-chart-bar mr-3"></i> Analytics
                        </a>
                    </li>
                    <li>
                        <a href="#" class="block px-4 py-2 hover:bg-blue-700 rounded flex items-center">
                            <i class="fas fa-cog mr-3"></i> Settings
                        </a>
                    </li>
                </ul>
            </nav>

            <div class="mt-auto"> 
                <h3 class="text-xs uppercase tracking-wider mb-2 text-blue-300">Admin Tools</h3>
                <ul class="space-y-2">
                    <li>
                        <a href="#" class="block px-4 py-2 hover:bg-blue-700 rounded flex items-center">
                            <i class="fas fa-user-cog mr-3"></i> Admin Settings
                        </a>
                    </li>
                    <li>
                        <a href="index.html" class="block px-4 py-2 hover:bg-blue-700 rounded flex items-center">
                            <i class="fas fa-sign-out-alt mr-3"></i> Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <div class="flex-1 flex flex-col overflow-hidden"> 
            <header class="bg-white shadow p-4 flex justify-between items-center sticky top-0 z-10 flex-shrink-0">
                <h2 class="text-xl font-semibold">Issue Management</h2>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="Search reports..." class="pl-10 pr-4 py-2 border rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <button id="add-report-button" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm">
                        <i class="fas fa-plus mr-1"></i> ALERT
                    </button>
                    <button id="refresh-button" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh
                    </button>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto p-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                     <div class="bg-white p-4 rounded-lg shadow">
                         <div class="flex items-center justify-between">
                             <div>
                                 <p class="text-sm text-gray-500">Total Reports</p>
                                 <p class="text-2xl font-bold" id="total-reports">0</p>
                             </div>
                             <div class="bg-blue-100 text-blue-600 p-3 rounded-full flex items-center justify-center w-10 h-10">
                                 <i class="fas fa-flag"></i>
                             </div>
                         </div>
                     </div>
                      <div class="bg-white p-4 rounded-lg shadow">
                          <div class="flex items-center justify-between">
                              <div>
                                  <p class="text-sm text-gray-500">Pending</p>
                                  <p class="text-2xl font-bold" id="pending-reports">0</p>
                              </div>
                              <div class="bg-yellow-100 text-yellow-600 p-3 rounded-full flex items-center justify-center w-10 h-10">
                                  <i class="fas fa-clock"></i>
                              </div>
                          </div>
                      </div>
                      <div class="bg-white p-4 rounded-lg shadow">
                          <div class="flex items-center justify-between">
                              <div>
                                  <p class="text-sm text-gray-500">In Progress</p>
                                  <p class="text-2xl font-bold" id="progress-reports">0</p>
                              </div>
                              <div class="bg-orange-100 text-orange-600 p-3 rounded-full flex items-center justify-center w-10 h-10">
                                  <i class="fas fa-tools"></i>
                              </div>
                          </div>
                      </div>
                      <div class="bg-white p-4 rounded-lg shadow">
                          <div class="flex items-center justify-between">
                              <div>
                                  <p class="text-sm text-gray-500">Completed</p>
                                  <p class="text-2xl font-bold" id="completed-reports">0</p>
                              </div>
                              <div class="bg-green-100 text-green-600 p-3 rounded-full flex items-center justify-center w-10 h-10">
                                  <i class="fas fa-check-circle"></i>
                              </div>
                          </div>
                      </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow mb-6">
                     <div class="flex flex-wrap items-center gap-4">
                         <div>
                             <label for="status-filter" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                             <select id="status-filter" class="border rounded-md px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500 w-full sm:w-auto">
                                 <option value="all">All Statuses</option>
                                 <option value="pending">Pending</option>
                                 <option value="in-progress">In Progress</option>
                                 <option value="completed">Completed</option>
                             </select>
                         </div>
                         <div>
                             <label for="category-filter" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                             <select id="category-filter" class="border rounded-md px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500 w-full sm:w-auto">
                                 <option value="all">All Categories</option>
                                 <option>Road Issues</option>
                                 <option>Public Safety</option>
                                 <option>Sanitation</option>
                                 <option>Utilities</option>
                                 <option>Other</option>
                             </select>
                         </div>
                         <div>
                             <label for="date-filter" class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                             <select id="date-filter" class="border rounded-md px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500 w-full sm:w-auto">
                                 <option value="all">All time</option>
                                 <option value="7">Last 7 days</option>
                                 <option value="30">Last 30 days</option>
                                 <option value="90">Last 90 days</option>
                             </select>
                         </div>
                         <div>
                             <label for="sort-filter" class="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
                             <select id="sort-filter" class="border rounded-md px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500 w-full sm:w-auto">
                                 <option value="newest">Newest First</option>
                                 <option value="oldest">Oldest First</option>
                                 <option value="most-upvotes">Most Upvotes</option>
                                 <option value="least-upvotes">Least Upvotes</option>
                             </select>
                         </div>
                     </div>
                 </div>

                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Issue</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Upvotes</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reported</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="issues-table-body">
                                </tbody>
                        </table>
                    </div>
                    <div id="no-results" class="hidden text-center p-6 text-gray-500">
                        No reports match the current filters.
                    </div>
                </div>

                <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                    <div class="bg-white rounded-lg p-6 w-full max-w-2xl my-8"> 
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Edit Issue Report</h3>
                            <button id="close-edit-modal" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times fa-lg"></i>
                            </button>
                        </div>
                        <form id="edit-form" class="space-y-4">
                            <input type="hidden" id="edit-issue-id">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="edit-issue-title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                                    <input type="text" id="edit-issue-title" class="w-full px-3 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                                </div>
                                <div>
                                    <label for="edit-issue-category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                                    <select id="edit-issue-category" class="w-full px-3 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                                        <option>Road Issues</option>
                                        <option>Public Safety</option>
                                        <option>Sanitation</option>
                                        <option>Utilities</option>
                                        <option>Other</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label for="edit-issue-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                <textarea id="edit-issue-description" rows="3" class="w-full px-3 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" required></textarea>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="edit-issue-location" class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                                    <input type="text" id="edit-issue-location" class="w-full px-3 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                                </div>
                                <div>
                                    <label for="edit-issue-status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                    <select id="edit-issue-status" class="w-full px-3 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                                        <option value="pending">Pending</option>
                                        <option value="in-progress">In Progress</option>
                                        <option value="completed">Completed</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Details</label>
                                <p class="text-sm text-gray-600">Reported By: <span id="edit-reported-by"></span> on <span id="edit-date-reported"></span></p>
                                <p class="text-sm text-gray-600">Upvotes: <span id="edit-upvotes"></span></p>
                            </div>
                            <div>
                                <label for="edit-issue-notes" class="block text-sm font-medium text-gray-700 mb-1">Admin Notes</label>
                                <textarea id="edit-issue-notes" rows="2" class="w-full px-3 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Add internal notes about this issue..."></textarea>
                            </div>
                            <div class="flex justify-end space-x-3 pt-2">
                                <button type="button" id="cancel-edit" class="px-4 py-2 border border-gray-300 rounded-md text-sm hover:bg-gray-50">Cancel</button>
                                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm hover:bg-blue-700">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="add-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                    <div class="bg-white rounded-lg p-6 w-full max-w-2xl my-8"> 
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Add New Issue Report</h3>
                            <button id="close-add-modal" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times fa-lg"></i>
                            </button>
                        </div>
                        <form id="add-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="add-issue-title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                                    <input type="text" id="add-issue-title" class="w-full px-3 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                                </div>
                                <div>
                                    <label for="add-issue-category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                                    <select id="add-issue-category" class="w-full px-3 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                                        <option>Road Issues</option>
                                        <option>Public Safety</option>
                                        <option>Sanitation</option>
                                        <option>Utilities</option>
                                        <option>Other</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label for="add-issue-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                <textarea id="add-issue-description" rows="3" class="w-full px-3 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" required></textarea>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="add-issue-location" class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                                    <input type="text" id="add-issue-location" class="w-full px-3 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                                </div>
                                <div>
                                    <label for="add-issue-status" class="block text-sm font-medium text-gray-700 mb-1">Initial Status</label>
                                    <select id="add-issue-status" class="w-full px-3 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500">
                                        <option value="pending">Pending</option>
                                        <option value="in-progress">In Progress</option>
                                        </select>
                                </div>
                            </div>
                             <div class="flex justify-end space-x-3 pt-2">
                                <button type="button" id="cancel-add" class="px-4 py-2 border border-gray-300 rounded-md text-sm hover:bg-gray-50">Cancel</button>
                                <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md text-sm hover:bg-green-700">Add Report</button>
                            </div>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Sample data for demonstration (using let so it can be modified)
        // In a real app, you'd fetch this from a server/API
        let issuesData = [
            {
                id: 1001,
                title: "Large Pothole on Main Street",
                description: "Deep pothole near the intersection with 5th Avenue, causing damage to vehicles.",
                category: "Road Issues",
                location: "Main St & 5th Ave",
                upvotes: 142,
                status: "pending",
                reportedBy: "Sarah J.",
                dateReported: "2025-04-15", // Using YYYY-MM-DD format
                adminNotes: ""
            },
            {
                id: 1002,
                title: "Broken Street Light",
                description: "Street light has been out for 3 weeks on Oak Street between 2nd and 3rd Avenue.",
                category: "Public Safety",
                location: "Oak St between 2nd & 3rd Ave",
                upvotes: 89,
                status: "in-progress",
                reportedBy: "Michael T.",
                dateReported: "2025-04-10",
                adminNotes: "Electrician scheduled"
            },
            {
                id: 1003,
                title: "Overflowing Trash Bin",
                description: "Public trash bin at the park has been overflowing for days, attracting pests.",
                category: "Sanitation",
                location: "Central Park, near fountain",
                upvotes: 53,
                status: "pending",
                reportedBy: "Lisa P.",
                dateReported: "2025-04-14",
                adminNotes: "Sanitation crew notified."
            },
            {
                id: 1004,
                title: "Damaged Sidewalk",
                description: "Uneven sidewalk tiles creating tripping hazard near elementary school.",
                category: "Public Safety",
                location: "Pine St near Maple Elementary",
                upvotes: 76,
                status: "completed",
                reportedBy: "Robert K.",
                dateReported: "2025-04-01",
                adminNotes: "Repairs completed April 10"
            },
            {
                id: 1005,
                title: "Graffiti on Building",
                description: "Extensive graffiti on the side of the community center building.",
                category: "Other",
                location: "123 Community Center Rd",
                upvotes: 34,
                status: "in-progress",
                reportedBy: "Emma L.",
                dateReported: "2025-04-12",
                adminNotes: "Cleanup scheduled"
            },
            {
                id: 1006,
                title: "Leaking Fire Hydrant",
                description: "Water is constantly leaking from the base of the hydrant.",
                category: "Utilities",
                location: "Corner of Elm St and 9th Ave",
                upvotes: 15,
                status: "pending",
                reportedBy: "David R.",
                dateReported: "2025-03-28",
                adminNotes: ""
            }
        ];

        // --- DOM Elements ---
        const issuesTableBody = document.getElementById('issues-table-body');
        const noResultsDiv = document.getElementById('no-results');

        // Modals
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const addModal = document.getElementById('add-modal');
        const addForm = document.getElementById('add-form');

        // Filters & Search
        const statusFilter = document.getElementById('status-filter');
        const categoryFilter = document.getElementById('category-filter');
        const dateFilter = document.getElementById('date-filter');
        const sortFilter = document.getElementById('sort-filter');
        const searchInput = document.getElementById('search-input');

        // Buttons
        const addReportButton = document.getElementById('add-report-button');
        const closeEditModalButton = document.getElementById('close-edit-modal');
        const cancelEditButton = document.getElementById('cancel-edit');
        const closeAddModalButton = document.getElementById('close-add-modal');
        const cancelAddButton = document.getElementById('cancel-add');
        const refreshButton = document.getElementById('refresh-button');

        // Status Counters
        const totalReportsElement = document.getElementById('total-reports');
        const pendingReportsElement = document.getElementById('pending-reports');
        const progressReportsElement = document.getElementById('progress-reports');
        const completedReportsElement = document.getElementById('completed-reports');

        // Edit Modal Fields (Spans)
        const editReportedBySpan = document.getElementById('edit-reported-by');
        const editDateReportedSpan = document.getElementById('edit-date-reported');
        const editUpvotesSpan = document.getElementById('edit-upvotes');


        // --- Helper Functions ---

        // Format Date (optional, for better display)
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                 // Check if date is valid before formatting
                if (isNaN(date.getTime())) {
                    return dateString; // Return original string if invalid
                }
                // Simple YYYY-MM-DD format is often fine, or use locale specific:
                // return date.toLocaleDateString();
                return dateString; // Keep original YYYY-MM-DD from data
            } catch (e) {
                return dateString; // Return original if error
            }
        }

        // Get Status Class for Badges
        function getStatusClass(status) {
            switch(status) {
                case 'pending': return 'bg-yellow-100 text-yellow-800';
                case 'in-progress': return 'bg-blue-100 text-blue-800';
                case 'completed': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // --- Core Logic ---

        // Render issues table
        function renderIssuesTable(issuesToRender) {
            issuesTableBody.innerHTML = ''; // Clear existing rows
            noResultsDiv.classList.add('hidden'); // Hide no results message initially

            if (!issuesToRender || issuesToRender.length === 0) {
                noResultsDiv.classList.remove('hidden'); // Show no results message
            } else {
                issuesToRender.forEach(issue => {
                    const row = document.createElement('tr');
                    row.classList.add('hover:bg-gray-50'); // Add hover effect

                    const statusClass = getStatusClass(issue.status);

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#${issue.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900 truncate" title="${issue.title}">${issue.title}</div>
                            <div class="text-sm text-gray-500">${issue.category}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate" title="${issue.location}">${issue.location}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
                            <i class="fas fa-arrow-up text-green-500 mr-1"></i> ${issue.upvotes}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(issue.dateReported)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2.5 py-0.5 text-xs font-semibold rounded-full ${statusClass} capitalize">
                                ${issue.status.replace('-', ' ')}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="edit-issue text-blue-600 hover:text-blue-900 mr-3" data-id="${issue.id}" title="Edit Issue">
                                <i class="fas fa-pencil-alt"></i> Edit
                            </button>
                            ${issue.status !== 'completed' ? // Only show Resolve if not completed
                                `<button class="resolve-issue text-green-600 hover:text-green-900" data-id="${issue.id}" title="Mark as Resolved">
                                    <i class="fas fa-check-circle"></i> Resolve
                                </button>` :
                                `<span class="text-gray-400 text-xs italic">Resolved</span>`
                            }
                        </td>
                    `;
                    issuesTableBody.appendChild(row);
                });
            }

            // Re-attach event listeners after rendering rows
            attachTableButtonListeners();
            updateStatusCounters(issuesData); // Update counters based on the *full* dataset
        }

        // Attach listeners to buttons within the table rows
        function attachTableButtonListeners() {
             // Edit buttons
            document.querySelectorAll('.edit-issue').forEach(button => {
                // Remove existing listener before adding a new one to prevent duplicates
                button.replaceWith(button.cloneNode(true));
            });
            document.querySelectorAll('.edit-issue').forEach(button => {
                button.addEventListener('click', () => openEditModal(button.dataset.id));
            });

             // Resolve buttons
             document.querySelectorAll('.resolve-issue').forEach(button => {
                 // Remove existing listener before adding a new one
                 button.replaceWith(button.cloneNode(true));
             });
            document.querySelectorAll('.resolve-issue').forEach(button => {
                button.addEventListener('click', () => resolveIssue(button.dataset.id));
            });
        }

        // Update status counters based on the full dataset
        function updateStatusCounters(allIssues) {
            totalReportsElement.textContent = allIssues.length;
            pendingReportsElement.textContent = allIssues.filter(i => i.status === 'pending').length;
            progressReportsElement.textContent = allIssues.filter(i => i.status === 'in-progress').length;
            completedReportsElement.textContent = allIssues.filter(i => i.status === 'completed').length;
        }

        // Filter and sort issues based on current filter selections
        function filterAndSortIssues() {
            let filtered = [...issuesData]; // Start with a copy of the full dataset
            const searchTerm = searchInput.value.toLowerCase();
            const selectedStatus = statusFilter.value;
            const selectedCategory = categoryFilter.value;
            const selectedDateRange = parseInt(dateFilter.value) || 'all';
            const selectedSort = sortFilter.value;

            // 1. Search Filter
            if (searchTerm) {
                filtered = filtered.filter(issue =>
                    issue.title.toLowerCase().includes(searchTerm) ||
                    issue.description.toLowerCase().includes(searchTerm) ||
                    issue.location.toLowerCase().includes(searchTerm) ||
                    issue.category.toLowerCase().includes(searchTerm) ||
                    String(issue.id).includes(searchTerm)
                );
            }

            // 2. Status Filter
            if (selectedStatus !== 'all') {
                filtered = filtered.filter(issue => issue.status === selectedStatus);
            }

            // 3. Category Filter
            if (selectedCategory !== 'all') {
                filtered = filtered.filter(issue => issue.category === selectedCategory);
            }

            // 4. Date Filter
            if (selectedDateRange !== 'all') {
                const now = new Date();
                const cutoffDate = new Date(now.setDate(now.getDate() - selectedDateRange));
                filtered = filtered.filter(issue => new Date(issue.dateReported) >= cutoffDate);
            }

            // 5. Sort
            switch(selectedSort) {
                case 'newest':
                    // Sort by date (desc), then by ID (desc) as a tie-breaker
                    filtered.sort((a, b) => new Date(b.dateReported) - new Date(a.dateReported) || b.id - a.id);
                    break;
                case 'oldest':
                    // Sort by date (asc), then by ID (asc) as a tie-breaker
                    filtered.sort((a, b) => new Date(a.dateReported) - new Date(b.dateReported) || a.id - b.id);
                    break;
                case 'most-upvotes':
                    // Sort by upvotes (desc), then by date (desc) as a tie-breaker
                    filtered.sort((a, b) => b.upvotes - a.upvotes || new Date(b.dateReported) - new Date(a.dateReported));
                    break;
                case 'least-upvotes':
                     // Sort by upvotes (asc), then by date (asc) as a tie-breaker
                    filtered.sort((a, b) => a.upvotes - b.upvotes || new Date(a.dateReported) - new Date(b.dateReported));
                    break;
            }

            return filtered;
        }

        // --- Modal Handling ---

        // Open edit modal
        function openEditModal(issueId) {
            const issue = issuesData.find(item => item.id == issueId); // Use == for potential string/number comparison
            if (issue) {
                document.getElementById('edit-issue-id').value = issue.id;
                document.getElementById('edit-issue-title').value = issue.title;
                document.getElementById('edit-issue-description').value = issue.description;
                document.getElementById('edit-issue-category').value = issue.category;
                document.getElementById('edit-issue-location').value = issue.location;
                document.getElementById('edit-issue-status').value = issue.status;
                document.getElementById('edit-issue-notes').value = issue.adminNotes;

                // Populate read-only fields
                editReportedBySpan.textContent = issue.reportedBy || 'N/A';
                editDateReportedSpan.textContent = formatDate(issue.dateReported);
                editUpvotesSpan.textContent = issue.upvotes;

                editModal.classList.remove('hidden');
            } else {
                 console.error("Issue not found for ID:", issueId);
                 alert("Error: Could not find the selected issue.");
            }
        }

        // Close edit modal
        function closeEditModal() {
            editModal.classList.add('hidden');
            editForm.reset(); // Optional: reset form on close
        }

        // Open add modal
        function openAddModal() {
            addForm.reset(); // Clear the form for a new entry
            document.getElementById('add-issue-status').value = 'pending'; // Default status
            addModal.classList.remove('hidden');
            document.getElementById('add-issue-title').focus(); // Focus first field
        }

        // Close add modal
        function closeAddModal() {
            addModal.classList.add('hidden');
            addForm.reset();
        }

        // --- Action Handlers ---

        // Handle filtering and re-rendering
        function handleFilterChange() {
            const filteredIssues = filterAndSortIssues();
            renderIssuesTable(filteredIssues);
        }

        // Resolve issue (mark as completed)
        function resolveIssue(issueId) {
            const issueIndex = issuesData.findIndex(item => item.id == issueId); // Use == for potential string/number comparison
            if (issueIndex !== -1 && issuesData[issueIndex].status !== 'completed') { // Check if found and not already completed
                issuesData[issueIndex].status = 'completed';
                const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                const existingNotes = issuesData[issueIndex].adminNotes ? issuesData[issueIndex].adminNotes + "\n" : "";
                issuesData[issueIndex].adminNotes = `${existingNotes}Resolved by admin on ${today}.`;

                handleFilterChange(); // Re-render table with updated status and filters
                alert(`Issue #${issueId} marked as resolved!`);
            } else if (issueIndex !== -1) {
                alert(`Issue #${issueId} is already resolved.`);
            } else {
                 console.error("Issue not found for resolving:", issueId);
                 alert("Error: Could not find the issue to resolve.");
            }
        }

        // Handle Edit Form Submission
        editForm.addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent default page reload

            const issueId = parseInt(document.getElementById('edit-issue-id').value);
            const issueIndex = issuesData.findIndex(item => item.id === issueId);

            if (issueIndex !== -1) {
                // Update the issue directly in the issuesData array
                issuesData[issueIndex].title = document.getElementById('edit-issue-title').value.trim();
                issuesData[issueIndex].description = document.getElementById('edit-issue-description').value.trim();
                issuesData[issueIndex].category = document.getElementById('edit-issue-category').value;
                issuesData[issueIndex].location = document.getElementById('edit-issue-location').value.trim();
                issuesData[issueIndex].status = document.getElementById('edit-issue-status').value;
                issuesData[issueIndex].adminNotes = document.getElementById('edit-issue-notes').value.trim();

                handleFilterChange(); // Re-render table with updated data and filters
                closeEditModal();
                alert('Changes saved successfully!');
            } else {
                alert('Error: Could not find the issue to update.');
                closeEditModal(); // Close modal even if error occurred
            }
        });

        // Handle Add Form Submission
        addForm.addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent default page reload

            // Generate a new ID (simple approach: find max current ID + 1)
            const maxId = issuesData.reduce((max, issue) => issue.id > max ? issue.id : max, 0);
            const newId = maxId + 1;

            // Get admin name (or default)
            const adminName = document.getElementById('admin-name').textContent || 'Admin';

            // Create new issue object from form data
            const newIssue = {
                id: newId,
                title: document.getElementById('add-issue-title').value.trim(),
                description: document.getElementById('add-issue-description').value.trim(),
                category: document.getElementById('add-issue-category').value,
                location: document.getElementById('add-issue-location').value.trim(),
                upvotes: 0, // Default new issues to 0 upvotes
                status: document.getElementById('add-issue-status').value,
                reportedBy: adminName, // Use admin name
                dateReported: new Date().toISOString().split('T')[0], // Current date YYYY-MM-DD
                adminNotes: "" // Start with empty notes
            };

            // Add the new issue to the main data array
            issuesData.push(newIssue);

            // Optional: Reset filters or sort to newest to see the added item easily
            sortFilter.value = 'newest';

            // Re-render the table with the new data & current filters
            handleFilterChange();

            closeAddModal(); // Close the modal
            alert('New issue report added successfully!');
        });


        // --- Event Listeners Setup ---

        // Modal Buttons
        addReportButton.addEventListener('click', openAddModal);
        closeEditModalButton.addEventListener('click', closeEditModal);
        cancelEditButton.addEventListener('click', closeEditModal);
        closeAddModalButton.addEventListener('click', closeAddModal);
        cancelAddButton.addEventListener('click', closeAddModal);

        // Filters & Search (call handler function on change/input)
        statusFilter.addEventListener('change', handleFilterChange);
        categoryFilter.addEventListener('change', handleFilterChange);
        dateFilter.addEventListener('change', handleFilterChange);
        sortFilter.addEventListener('change', handleFilterChange);
        searchInput.addEventListener('input', handleFilterChange); // Use 'input' for real-time search

        // Refresh Button
        refreshButton.addEventListener('click', () => {
            // In a real app, this might re-fetch data from the server
            // For this example, just re-apply filters/sort to the existing data
            alert('Dashboard refreshed.');
            handleFilterChange();
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set admin name (example, replace with actual auth logic)
            document.getElementById('admin-name').textContent = localStorage.getItem('urbanEchoAdminName') || 'Admin User';

            // Initial render of the table with default filters/sort
            handleFilterChange();
        });

    </script>

</body>
</html>